{% extends 'base.html' %}
{% load static %}
{% load patient_extras %}

{% block title %}Patient Dashboard - {{ patient.user.first_name }} {{ patient.user.last_name }}{% endblock %}

{% block extra_head %}
<style>
    /* AI Analysis Button Advanced Animations */
    @keyframes float-particle {
        0% {
            transform: translate(0, 0) scale(0);
            opacity: 0;
        }
        10% {
            opacity: 1;
            transform: translate(0, 0) scale(1);
        }
        100% {
            transform: translate(calc(100px * var(--x)), calc(-100px * var(--y))) scale(0);
            opacity: 0;
        }
    }
    
    @keyframes scan-line {
        0% {
            transform: translateY(-100%);
            opacity: 0;
        }
        50% {
            opacity: 1;
        }
        100% {
            transform: translateY(100%);
            opacity: 0;
        }
    }
    
    @keyframes ripple-effect {
        0% {
            width: 0;
            height: 0;
            opacity: 0.5;
        }
        100% {
            width: 300px;
            height: 300px;
            opacity: 0;
        }
    }
    
    @keyframes brain-pulse {
        0%, 100% {
            transform: scale(1);
            stroke: currentColor;
        }
        50% {
            transform: scale(1.1);
            stroke: #8b5cf6;
        }
    }
    
    @keyframes gradient-shift {
        0% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
        100% {
            background-position: 0% 50%;
        }
    }
    
    @keyframes glow-pulse {
        0%, 100% {
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5),
                        0 0 10px rgba(59, 130, 246, 0.3),
                        0 0 15px rgba(59, 130, 246, 0.1);
        }
        50% {
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.8),
                        0 0 20px rgba(139, 92, 246, 0.6),
                        0 0 30px rgba(139, 92, 246, 0.4);
        }
    }
    
    /* Particle animations with random positions */
    .ai-particle:nth-child(1) {
        --x: -0.5;
        --y: 0.8;
        left: 20%;
        top: 50%;
    }
    
    .ai-particle:nth-child(2) {
        --x: 0.5;
        --y: 0.6;
        left: 50%;
        top: 50%;
    }
    
    .ai-particle:nth-child(3) {
        --x: -0.3;
        --y: 0.9;
        left: 80%;
        top: 50%;
    }
    
    .ai-analysis-btn:hover .ai-particle {
        animation: float-particle 2s ease-out infinite;
    }
    
    .ai-analysis-btn:hover .ai-scan-line {
        animation: scan-line 2s ease-in-out infinite;
        opacity: 0.5;
    }
    
    .ai-analysis-btn:hover .ai-ripple span {
        animation: ripple-effect 1.5s ease-out infinite;
    }
    
    .ai-analysis-btn:hover .ai-brain {
        animation: brain-pulse 1.5s ease-in-out infinite;
    }
    
    .ai-analysis-btn:hover .ai-path-2 {
        opacity: 1;
        animation: brain-pulse 1.5s ease-in-out infinite;
        animation-delay: 0.2s;
    }
    
    .ai-analysis-btn:hover {
        animation: glow-pulse 2s ease-in-out infinite;
        transform: translateY(-2px);
    }
    
    .ai-gradient-bg {
        background-size: 200% 200%;
        animation: gradient-shift 3s ease infinite;
    }
    
    /* Loading state animations */
    @keyframes data-flow {
        0% {
            stroke-dashoffset: 100;
        }
        100% {
            stroke-dashoffset: 0;
        }
    }
    
    .ai-analyzing {
        position: relative;
        overflow: visible;
    }
    
    .ai-analyzing::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899, #3b82f6);
        background-size: 300% 300%;
        border-radius: 0.5rem;
        opacity: 0.8;
        animation: gradient-shift 1s linear infinite;
        z-index: -1;
    }
    
    .ai-analyzing svg {
        stroke-dasharray: 100;
        animation: data-flow 1.5s linear infinite;
    }
</style>
{% endblock %}

{% block nav_patients %}border-b-2 border-blue-500 text-gray-900{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <!-- Patient Header -->
    <div class="px-4 py-6 sm:px-0">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="px-6 py-6 sm:p-8">
                <div class="flex flex-col sm:flex-row sm:justify-between gap-4">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:space-x-4">
                        <!-- Patient Avatar -->
                        <div class="flex-shrink-0 mb-4 sm:mb-0">
                            <div class="h-16 w-16 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xl mx-auto sm:mx-0">
                                {{ patient.user.first_name|slice:":1" }}{{ patient.user.last_name|slice:":1" }}
                            </div>
                        </div>
                        
                        <!-- Patient Details -->
                        <div class="text-center sm:text-left">
                            <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">
                                {{ patient.user.first_name }} {{ patient.user.last_name }}
                            </h2>
                            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="flex items-center justify-center sm:justify-start text-sm text-gray-600">
                                    <svg class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
                                    </svg>
                                    <span class="font-medium">ID:</span>&nbsp;#{{ patient.id }}
                                </div>
                                <div class="flex items-center justify-center sm:justify-start text-sm text-gray-600">
                                    <svg class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="break-all"><span class="font-medium">Email:</span>&nbsp;{{ patient.user.email }}</span>
                                </div>
                                <div class="flex items-center justify-center sm:justify-start text-sm text-gray-600">
                                    <svg class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    <span class="font-medium">Phone:</span>&nbsp;{{ patient.phone_number|default:"Not provided" }}
                                </div>
                                <div class="flex items-center justify-center sm:justify-start text-sm text-gray-600">
                                    <svg class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="font-medium">DOB:</span>&nbsp;
                                    {% if patient.date_of_birth %}
                                        {{ patient.date_of_birth|format_date }} ({{ patient.date_of_birth|calculate_age }} years old)
                                    {% else %}
                                        Not provided
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Back Button -->
                    <button onclick="window.location.href='/clinician/dashboard/'" class="inline-flex items-center px-3 py-1 border border-transparent shadow-sm text-xs sm:text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Info -->
    <div class="mt-4 p-4 bg-yellow-100 rounded-lg" style="display: none;">
        <h4 class="font-bold mb-2">Debug: Patient Data</h4>
        <pre>{{ patient|pprint }}</pre>
    </div>
    
    <!-- Patient Information (Collapsible) -->
    <div class="mt-8" x-data="{ open: true }">
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <!-- Collapsible Header -->
            <button @click="open = !open" class="w-full px-6 py-4 bg-gray-50 hover:bg-gray-100 transition-colors duration-150 focus:outline-none">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Patient Information
                    </h3>
                    <svg class="w-5 h-5 text-gray-600 transform transition-transform duration-200" :class="{'rotate-180': open}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>
            
            <!-- Collapsible Content -->
            <div x-show="open" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 transform scale-100" x-transition:leave-end="opacity-0 transform scale-95">
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <div class="pl-4">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Full Name</p>
                                <p class="text-sm font-medium text-gray-900">{{ patient.user.first_name }} {{ patient.user.last_name }}</p>
                            </div>
                            
                            <div class="pl-4">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Date of Birth</p>
                                <p class="text-sm font-medium text-gray-900">
                                    {% if patient.date_of_birth %}
                                        {{ patient.date_of_birth|format_date }}
                                        <span class="text-gray-600">({{ patient.date_of_birth|calculate_age }} years old)</span>
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </p>
                            </div>
                            
                            <div class="pl-4">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Gender</p>
                                <p class="text-sm font-medium text-gray-900">{{ patient.gender|title|default:"Not specified" }}</p>
                            </div>
                            
                            <div class="pl-4">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Preferred Language</p>
                                <p class="text-sm font-medium text-gray-900">{{ patient.preferred_language.name|default:"English" }}</p>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="space-y-4">
                            <div class="pl-4">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Phone Number</p>
                                <p class="text-sm font-medium text-gray-900">{{ patient.phone_number|default:"Not provided" }}</p>
                            </div>
                            
                            <div class="pl-4">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Email Address</p>
                                <p class="text-sm font-medium text-gray-900">{{ patient.user.email }}</p>
                            </div>
                            
                            <div class="pl-4">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Home Address</p>
                                <p class="text-sm font-medium text-gray-900">{{ patient.address|default:"Not provided" }}</p>
                            </div>
                            
                            <div class="pl-4">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Emergency Contact</p>
                                <p class="text-sm font-medium text-gray-900">{{ patient.emergency_contact_name|default:"Not provided" }}</p>
                                {% if patient.emergency_contact_phone %}
                                <p class="text-sm text-gray-600">{{ patient.emergency_contact_phone }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="mt-8">
        <h3 class="text-lg leading-6 font-medium text-gray-900 px-4">Overview</h3>
        <div class="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3 px-4">
            <!-- Cancer Type -->
            <div class="bg-white overflow-hidden shadow rounded-lg border-2 border-blue-100">
                <div class="p-5 bg-blue-50">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-700 truncate">Cancer Type</dt>
                                <dd class="text-sm font-semibold text-gray-900">
                                    {% if patient.assignment %}
                                        {{ patient.assignment.cancer_subtype_name|default:"Not specified" }}
                                    {% else %}
                                        Not assigned
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assigned Clinician -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Assigned Clinician</dt>
                                <dd class="text-sm font-medium text-gray-900 truncate">
                                    {% if patient.assignment and patient.assignment.assigned_clinician %}
                                        Dr. {{ clinician.user.first_name }} {{ clinician.user.last_name }}
                                    {% else %}
                                        Pending
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical Records -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Medical Records</dt>
                                <dd class="text-lg font-medium text-gray-900">{{ medical_records|length|default:0 }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prescriptions -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Active Prescriptions</dt>
                                <dd class="text-lg font-medium text-gray-900">{{ prescriptions|length|default:0 }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointments -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Appointments</dt>
                                <dd class="text-lg font-medium text-gray-900">{{ appointments|length|default:0 }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignment Status -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Assignment Status</dt>
                                <dd class="text-lg font-medium text-gray-900">{% if patient.assignment %}Active{% else %}Pending{% endif %}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medical Records Section -->
    <div class="mt-8">
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <div class="flex justify-between items-center flex-wrap gap-2">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Medical Records</h3>
                    <button onclick="window.location.href='/clinician/patients/{{ patient.id }}/add-record/'" 
                            class="inline-flex items-center px-3 py-1.5 sm:px-3 sm:py-2 border border-transparent text-xs sm:text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="-ml-0.5 mr-1 sm:mr-2 h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Record
                    </button>
                </div>
            </div>
            <div class="px-4 py-5 sm:p-6">
                {% if medical_records %}
                    <ul class="divide-y divide-gray-200">
                        {% for record in medical_records %}
                        <li class="py-4 border-b border-gray-100 hover:bg-gray-50 transition-colors duration-200">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
                                <div class="flex-1">
                                    <h4 class="text-sm font-medium text-gray-900 break-all">{{ record.file_detail.filename }}</h4>
                                    <p class="text-sm text-gray-600 mt-1">{{ record.medical_record_type_detail.type_name }}</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <svg class="mr-1.5 h-4 w-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="break-words">Uploaded {{ record.created_at|date:"M d, Y" }} at {{ record.created_at|date:"g:i A" }}</span>
                                    </div>
                                    {% if record.uploaded_by_detail %}
                                    <p class="text-xs text-gray-500 mt-1">
                                        By {{ record.uploaded_by_detail.name }}
                                    </p>
                                    {% endif %}
                                </div>
                                <div class="flex-shrink-0 flex flex-row sm:flex-col lg:flex-row gap-2 sm:gap-2 items-center">
                                    <!-- AI Analysis button first -->
                                    <button onclick="analyzeMedicalRecord('{{ record.file }}', '{{ record.file_detail.filename }}')" 
                                            class="ai-analysis-btn group relative inline-flex items-center justify-center px-3 py-1 overflow-hidden font-medium text-blue-700 transition duration-300 ease-out border-2 border-blue-500 rounded shadow-md hover:shadow-xl">
                                        <!-- Animated gradient background -->
                                        <span class="absolute inset-0 flex h-full w-full">
                                            <span class="ai-gradient-bg absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-0 group-hover:opacity-20 transition-opacity duration-500"></span>
                                        </span>
                                        
                                        <!-- Ripple effect circles -->
                                        <span class="ai-ripple absolute top-0 left-0 w-full h-full">
                                            <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-0 h-0 rounded-full bg-blue-400 opacity-0"></span>
                                        </span>
                                        
                                        <!-- Floating particles -->
                                        <span class="absolute inset-0 pointer-events-none">
                                            <span class="ai-particle absolute w-1 h-1 bg-blue-400 rounded-full opacity-0"></span>
                                            <span class="ai-particle absolute w-1 h-1 bg-purple-400 rounded-full opacity-0" style="animation-delay: 0.5s"></span>
                                            <span class="ai-particle absolute w-1 h-1 bg-pink-400 rounded-full opacity-0" style="animation-delay: 1s"></span>
                                        </span>
                                        
                                        <!-- Icon with complex animation -->
                                        <span class="relative flex items-center">
                                            <svg class="w-4 h-4 sm:w-3 sm:h-3 sm:-ml-0.5 sm:mr-1 ai-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <!-- Brain/AI icon with animated paths -->
                                                <g class="ai-brain">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                          d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                                                          class="ai-path-1"></path>
                                                    <circle cx="12" cy="12" r="3" class="ai-path-2" stroke-width="2" fill="none" opacity="0"></circle>
                                                </g>
                                            </svg>
                                            <span class="hidden sm:inline text-xs font-semibold">
                                                AI Analysis
                                            </span>
                                        </span>
                                        
                                        <!-- Scanning line effect -->
                                        <span class="ai-scan-line absolute inset-x-0 h-px bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-0"></span>
                                    </button>
                                    
                                    <!-- Separator -->
                                    <div class="hidden sm:block w-px h-8 bg-gray-300 mx-1"></div>
                                    
                                    <!-- Standard action buttons group -->
                                    <div class="flex flex-row gap-2">
                                        <button onclick="viewMedicalRecord('{{ record.file }}', '{{ record.file_detail.filename }}')" 
                                                class="inline-flex items-center justify-center px-2 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <svg class="sm:-ml-0.5 sm:mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                            <span class="hidden sm:inline">View</span>
                                        </button>
                                        <a href="/api/files/medical-records/{{ record.file }}/download/" 
                                           class="inline-flex items-center justify-center px-2 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <svg class="sm:-ml-0.5 sm:mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                            </svg>
                                            <span class="hidden sm:inline">Download</span>
                                        </a>
                                        <button onclick="deleteMedicalRecord('{{ record.file }}', '{{ record.file_detail.filename }}')" 
                                                class="inline-flex items-center justify-center px-2 py-1 border border-red-300 shadow-sm text-xs font-medium rounded text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            <svg class="sm:-ml-0.5 sm:mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            <span class="hidden sm:inline">Delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No medical records</h3>
                        <p class="mt-1 text-sm text-gray-500">Medical records will appear here once added.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Prescriptions Section -->
    <div class="mt-8">
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Prescriptions</h3>
                    <button class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" disabled>
                        <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Prescription
                    </button>
                </div>
            </div>
            <div class="px-4 py-5 sm:p-6">
                {% if prescriptions %}
                    <ul class="divide-y divide-gray-200">
                        {% for prescription in prescriptions %}
                        <li class="py-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-sm font-medium text-gray-900">{{ prescription.medication_name }}</h4>
                                    <p class="text-sm text-gray-600 mt-1">
                                        {{ prescription.dosage }} - {{ prescription.frequency }}
                                    </p>
                                    <p class="text-xs text-gray-500 mt-2">
                                        Prescribed: {{ prescription.prescribed_date|date:"M d, Y" }}
                                        {% if prescription.end_date %}
                                        - Until: {{ prescription.end_date|date:"M d, Y" }}
                                        {% endif %}
                                    </p>
                                </div>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if prescription.is_active %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {% if prescription.is_active %}Active{% else %}Completed{% endif %}
                                </span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No prescriptions</h3>
                        <p class="mt-1 text-sm text-gray-500">Prescriptions will appear here once added.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Appointments and Recent Activity -->
    <div class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-2">
        <!-- Appointments Section -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Appointments</h3>
                    <button class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" disabled>
                        <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Schedule
                    </button>
                </div>
            </div>
            <div class="px-4 py-5 sm:p-6">
                {% if appointments %}
                    <ul class="divide-y divide-gray-200">
                        {% for appointment in appointments %}
                        <li class="py-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-sm font-medium text-gray-900">{{ appointment.type }}</h4>
                                    <p class="text-sm text-gray-600 mt-1">
                                        {{ appointment.date|date:"F d, Y" }} at {{ appointment.time|time:"g:i A" }}
                                    </p>
                                    <p class="text-sm text-gray-500 mt-1">
                                        Dr. {{ appointment.clinician_name }}
                                    </p>
                                    {% if appointment.notes %}
                                    <p class="text-xs text-gray-500 mt-2">{{ appointment.notes }}</p>
                                    {% endif %}
                                </div>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if appointment.status == 'completed' %}bg-green-100 text-green-800{% elif appointment.status == 'cancelled' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {{ appointment.status|title }}
                                </span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No appointments</h3>
                        <p class="mt-1 text-sm text-gray-500">Appointments will appear here once scheduled.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Recent Activity</h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                {% if recent_activity %}
                    <ul class="divide-y divide-gray-200">
                        {% for activity in recent_activity %}
                        <li class="py-4">
                            <div>
                                <h4 class="text-sm font-medium text-gray-900">{{ activity.title }}</h4>
                                <p class="text-sm text-gray-600 mt-1">{{ activity.description }}</p>
                                <p class="text-xs text-gray-500 mt-1">{{ activity.timestamp|timesince }} ago</p>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No recent activity</h3>
                        <p class="mt-1 text-sm text-gray-500">Patient activity will appear here.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Medical Record View Modal -->
<div id="medicalRecordModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-start justify-between">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                        <span id="modalFileName">Medical Record</span>
                    </h3>
                    <button onclick="closeModal()" class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mt-3">
                    <iframe id="pdfViewer" src="" class="w-full h-64 sm:h-96 lg:h-[32rem] border border-gray-300 rounded"></iframe>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <a id="downloadButton" href="#" download class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Download
                </a>
                <button onclick="closeModal()" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
            <div class="sm:flex sm:items-start">
                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                        Delete Medical Record
                    </h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500">
                            Are you sure you want to delete "<span id="deleteFileName" class="font-medium"></span>"? This action cannot be undone.
                        </p>
                        <p class="text-sm text-gray-500 mt-2">
                            This will permanently remove:
                        </p>
                        <ul class="text-sm text-gray-500 mt-1 ml-4 list-disc">
                            <li>The medical record file</li>
                            <li>All access permissions</li>
                            <li>Associated metadata</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="confirmDelete()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Delete
                </button>
                <button type="button" onclick="closeDeleteModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTempFileId = null;

async function viewMedicalRecord(fileId, fileName) {
    // Set modal title
    document.getElementById('modalFileName').textContent = fileName;
    
    try {
        // Show loading state
        document.getElementById('pdfViewer').src = '';
        document.getElementById('pdfViewer').style.display = 'none';
        
        // Create a loading message
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingMessage';
        loadingDiv.className = 'text-center py-8';
        loadingDiv.innerHTML = '<p class="text-gray-500">Loading medical record...</p>';
        document.getElementById('pdfViewer').parentNode.insertBefore(loadingDiv, document.getElementById('pdfViewer'));
        
        // Request temporary file creation
        const token = localStorage.getItem('access_token') || getCookie('access_token');
        const response = await fetch(`/api/files/medical-records/${fileId}/view/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            currentTempFileId = data.temp_id;
            
            // Remove loading message
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
            
            // Set PDF viewer to temporary file URL
            document.getElementById('pdfViewer').src = data.temp_url;
            document.getElementById('pdfViewer').style.display = 'block';
            
            // Set download link
            document.getElementById('downloadButton').href = `/api/files/medical-records/${fileId}/download/`;
            
            // Show modal
            document.getElementById('medicalRecordModal').classList.remove('hidden');
        } else {
            const error = await response.json();
            alert(`Failed to load medical record: ${error.error || 'Unknown error'}`);
            
            // Remove loading message
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
        }
    } catch (error) {
        console.error('Error viewing medical record:', error);
        alert('Failed to load medical record');
        
        // Remove loading message
        const loading = document.getElementById('loadingMessage');
        if (loading) loading.remove();
    }
}

async function closeModal() {
    document.getElementById('medicalRecordModal').classList.add('hidden');
    document.getElementById('pdfViewer').src = '';
    
    // Clean up temporary file if it exists
    if (currentTempFileId) {
        try {
            const token = localStorage.getItem('access_token') || getCookie('access_token');
            await fetch('/api/files/temp/cleanup/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ temp_id: currentTempFileId })
            });
            currentTempFileId = null;
        } catch (error) {
            console.error('Error cleaning up temporary file:', error);
        }
    }
}

// Store the file ID and name for deletion
let pendingDeleteFileId = null;
let pendingDeleteFileName = null;

function deleteMedicalRecord(fileId, fileName) {
    // Store the file info for later use
    pendingDeleteFileId = fileId;
    pendingDeleteFileName = fileName;
    
    // Update the modal with the file name
    document.getElementById('deleteFileName').textContent = fileName;
    
    // Show the delete confirmation modal
    document.getElementById('deleteConfirmModal').classList.remove('hidden');
}

function closeDeleteModal() {
    // Hide the modal
    document.getElementById('deleteConfirmModal').classList.add('hidden');
    
    // Clear the pending delete info
    pendingDeleteFileId = null;
    pendingDeleteFileName = null;
}

function confirmDelete() {
    if (!pendingDeleteFileId) return;
    
    const token = localStorage.getItem('access_token') || getCookie('access_token');
    
    // Show loading state on delete button
    const deleteButton = event.target;
    const originalText = deleteButton.textContent;
    deleteButton.textContent = 'Deleting...';
    deleteButton.disabled = true;
    
    fetch(`/api/files/medical-records/${pendingDeleteFileId}/delete/`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${token}`,
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Failed to delete medical record');
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || 'Failed to delete medical record');
        
        // Reset button state
        deleteButton.textContent = originalText;
        deleteButton.disabled = false;
        
        // Close modal
        closeDeleteModal();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Load OCR Analysis JavaScript
// This is loaded from static/js/ocr-analysis.js
</script>

<!-- Load OCR Analysis JavaScript -->
<script src="{% static 'js/ocr-analysis.js' %}"></script>

{% endblock %}